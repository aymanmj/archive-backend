# ---------- deps ----------
FROM node:20-alpine AS deps
WORKDIR /app

# Ø£Ø¯ÙˆØ§Øª Ø¨Ù†Ø§Ø¡ Ù„Ø£ÙŠ Ø­Ø²Ù… native
RUN apk add --no-cache python3 make g++

# pnpm
RUN corepack enable && corepack prepare pnpm@9.12.0 --activate

# Ø£Ù‚ØµÙ‰ Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# ---------- build ----------
FROM node:20-alpine AS build
WORKDIR /app
RUN corepack enable && corepack prepare pnpm@9.12.0 --activate

# Ù†Ù†Ø³Ø® node_modules Ù…Ù† deps
COPY --from=deps /app/node_modules ./node_modules

# Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³ÙˆØ±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¨Ù†Ø§Ø¡
COPY . .

# ØªÙˆÙ„ÙŠØ¯ Prisma
RUN npx prisma generate

# Ù†Ø¨Ù†ÙŠ Nest (ÙŠÙØªØ±Ø¶ script: "build": "nest build")
RUN pnpm build

# âœ… Ø§Ø·Ø¨Ø¹ Ø´Ø¬Ø±Ø© dist Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ ÙˆØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
RUN echo "ğŸ“ dist layout:" && ls -la dist && ( \
      [ -f dist/main.js ] || \
      [ -f dist/src/main.js ] || \
      echo "no root main.js but dist/src exists (common in Nest)"; \
    )

# ---------- runtime ----------
FROM node:20-alpine AS runtime
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

# Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙ‚Ø·
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/dist ./dist
COPY --from=build /app/prisma ./prisma
COPY --from=build /app/package.json ./package.json

# Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
COPY entrypoint.sh ./entrypoint.sh
RUN chmod +x ./entrypoint.sh

EXPOSE 3000
CMD ["./entrypoint.sh"]
