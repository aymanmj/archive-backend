// =========================
// schema.prisma (v1.2)
// =========================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Enums ============

enum DocumentStatus {
  Draft
  Registered
  UnderReview
  Completed
  Archived
  Rejected
}

enum DistributionStatus {
  Open
  InProgress
  Closed
  Escalated
}

enum WorkflowStatus {
  InProgress
  Completed
  Cancelled
}

enum WorkflowActionType {
  REVIEWED
  FORWARDED
  APPROVED
  REJECTED
  COMMENT
}

enum DeliveryMethod {
  Hand
  Mail
  Email
  Courier
  Fax
  ElectronicSystem
}

enum UrgencyLevel {
  Low
  Normal
  High
  Urgent
}

enum NotificationSeverity {
  info
  warning
  danger
}

enum NotificationStatus {
  Unread
  Read
}

// ============ Models ============

model Department {
  id                 Int      @id @default(autoincrement())
  name               String
  status             String   @default("Active")
  parentDepartmentId Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Soft delete
  isDeleted       Boolean   @default(false)
  deletedAt       DateTime?
  deletedByUserId Int?

  parentDepartment      Department?            @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id], onDelete: SetNull)
  subDepartments        Department[]           @relation("DepartmentHierarchy")
  owningDocuments       Document[]             @relation("OwningDepartment")
  incomingDistributions IncomingDistribution[] @relation("IncomingTargetDept")
  users                 User[]

  @@map("Department")

  @@index([status])
  @@index([parentDepartmentId])
}

model User {
  id                    Int       @id @default(autoincrement())
  fullName              String
  jobTitle              String?
  email                 String?   @unique
  username              String    @unique
  passwordHash          String
  isActive              Boolean   @default(true)
  departmentId          Int?
  securityClearanceRank Int       @default(0)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastLoginAt           DateTime?

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  isSystem Boolean @default(false)

  /// جديد: لو true يُجبر على تغيير كلمة المرور عند أول دخول
  mustChangePassword Boolean @default(false)

  failedLoginAttempts Int       @default(0)
  lockoutUntil        DateTime?

  AuditTrail                    AuditTrail[]
  documentsCreated              Document[]                @relation("UserCreatedDocuments")
  uploadedFiles                 DocumentFile[]            @relation("UserUploadedFiles")
  assignedIncomingDistributions IncomingDistribution[]    @relation("AssignedIncomingDistributions")
  incomingReceived              IncomingRecord[]          @relation("UserReceivedIncoming")
  OutgoingRecord                OutgoingRecord[]
  department                    Department?               @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  UserRole                      UserRole[]
  WorkflowStepAction            WorkflowStepAction[]
  logsUpdatedByMe               IncomingDistributionLog[] @relation("LogsUpdatedByUser")

  // العكسي لعلاقة currentAssignee
  workflowAssignedInstances WorkflowInstance[] @relation("WorkflowInstanceCurrentAssignee")

  passwordResets PasswordReset[]
  notifications  Notification[]

  @@map("User")


  @@index([departmentId])
  @@index([securityClearanceRank])
  @@index([isActive])
}

model DocumentType {
  id             Int        @id @default(autoincrement())
  typeName       String
  isIncomingType Boolean    @default(false)
  isOutgoingType Boolean    @default(false)
  isInternalMemo Boolean    @default(false)
  description    String?
  documents      Document[]

  @@map("DocumentType")


  @@unique([typeName])
  @@index([isIncomingType])
  @@index([isOutgoingType])
  @@index([isInternalMemo])
}

model Document {
  id                   BigInt         @id @default(autoincrement())
  title                String
  summary              String?
  currentStatus        DocumentStatus @default(Draft)
  isPhysicalCopyExists Boolean        @default(false)
  physicalLocation     String?
  isDeleted            Boolean        @default(false)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  documentTypeId     Int
  securityLevelId    Int
  createdByUserId    Int
  owningDepartmentId Int

  // [NEW] ناقل البحث FTS
  searchVector Unsupported("tsvector")?

  AuditTrail       AuditTrail[]
  createdByUser    User               @relation("UserCreatedDocuments", fields: [createdByUserId], references: [id], onDelete: Restrict)
  documentType     DocumentType       @relation(fields: [documentTypeId], references: [id], onDelete: Restrict)
  owningDepartment Department         @relation("OwningDepartment", fields: [owningDepartmentId], references: [id], onDelete: Restrict)
  securityLevel    SecurityLevel      @relation(fields: [securityLevelId], references: [id], onDelete: Restrict)
  files            DocumentFile[]
  DocumentMetadata DocumentMetadata[]
  DocumentTagLink  DocumentTagLink[]
  incomingRecord   IncomingRecord?
  OutgoingRecord   OutgoingRecord?
  WorkflowInstance WorkflowInstance[]
  OCRText          OCRText[] // [NEW] نصوص OCR

  @@map("Document")


  @@index([currentStatus])
  @@index([owningDepartmentId])
  @@index([createdAt])
  @@index([securityLevelId])
  @@index([documentTypeId])
  @@index([searchVector], type: Gin) // [NEW] فهرس GIN على الناقل
}

model DocumentFile {
  id               BigInt   @id @default(autoincrement())
  documentId       BigInt
  fileNameOriginal String
  storagePath      String
  fileExtension    String
  fileSizeBytes    BigInt
  checksumHash     String
  versionNumber    Int
  isLatestVersion  Boolean  @default(true)
  uploadedByUserId Int
  uploadedAt       DateTime @default(now())

  document       Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  uploadedByUser User     @relation("UserUploadedFiles", fields: [uploadedByUserId], references: [id], onDelete: Restrict)

  @@map("DocumentFile")


  @@unique([documentId, versionNumber])
  @@index([documentId, isLatestVersion, versionNumber])
  @@index([checksumHash])
}

model ExternalParty {
  id          Int      @id @default(autoincrement())
  name        String
  type        String?
  contactInfo String?
  status      String?  @default("Active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Soft delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  incomingRecords IncomingRecord[]
  OutgoingRecord  OutgoingRecord[]

  @@map("ExternalParty")


  @@index([status])
  @@index([name])
}

model IncomingRecord {
  id                 BigInt         @id @default(autoincrement())
  documentId         BigInt         @unique
  externalPartyId    Int
  receivedDate       DateTime
  receivedByUserId   Int
  incomingNumber     String         @unique
  deliveryMethod     DeliveryMethod
  urgencyLevel       UrgencyLevel?
  requiredAction     String?
  dueDateForResponse DateTime?
  receivedAt         DateTime       @default(now())

  updatedAt DateTime @updatedAt @map("updatedat")

  distributions  IncomingDistribution[]
  document       Document               @relation(fields: [documentId], references: [id], onDelete: Restrict)
  externalParty  ExternalParty          @relation(fields: [externalPartyId], references: [id], onDelete: Restrict)
  receivedByUser User                   @relation("UserReceivedIncoming", fields: [receivedByUserId], references: [id], onDelete: Restrict)

  @@map("IncomingRecord")


  @@index([receivedDate])
  @@index([externalPartyId])
}

model IncomingDistribution {
  id                 BigInt             @id @default(autoincrement())
  incomingId         BigInt
  targetDepartmentId Int
  assignedToUserId   Int?
  status             DistributionStatus @default(Open)
  notes              String?
  lastUpdateAt       DateTime           @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // ✅ SLA
  dueAt           DateTime?
  priority        Int       @default(0) // 0=Normal, 1=High, 2=Critical
  escalationCount Int       @default(0)

  assignedToUser   User?          @relation("AssignedIncomingDistributions", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  incoming         IncomingRecord @relation(fields: [incomingId], references: [id], onDelete: Restrict)
  targetDepartment Department     @relation("IncomingTargetDept", fields: [targetDepartmentId], references: [id], onDelete: Restrict)

  logs IncomingDistributionLog[]

  @@map("IncomingDistribution")

  @@index([targetDepartmentId])
  @@index([status])
  @@index([targetDepartmentId, status, lastUpdateAt])
  @@index([createdAt])
  // ✅ فهارس مساعدة لـ SLA
  @@index([dueAt])
  @@index([status, dueAt])
}

model AuditTrail {
  id                BigInt   @id @default(autoincrement())
  documentId        BigInt?
  userId            Int?
  actionType        String
  actionDescription String?
  actionAt          DateTime @default(now())
  fromIP            String?
  workstationName   String?

  // [NEW] تتبع الطلب
  requestId     String?
  correlationId String?
  createdAt     DateTime @default(now())

  Document Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  User     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("AuditTrail")


  @@index([documentId])
  @@index([userId])
  @@index([actionAt])
  @@index([correlationId]) // [NEW]
}

model DocumentMetadata {
  id           BigInt  @id @default(autoincrement())
  documentId   BigInt
  metaKey      String
  metaValue    String
  isSearchable Boolean @default(true)

  Document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("DocumentMetadata")

  @@index([metaKey])
  @@index([metaValue])
  @@index([documentId, metaKey])
}

model DocumentTag {
  id              Int               @id @default(autoincrement())
  tagName         String            @unique
  DocumentTagLink DocumentTagLink[]

  @@map("DocumentTag")

}

model DocumentTagLink {
  id         BigInt @id @default(autoincrement())
  documentId BigInt
  tagId      Int

  Document    Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  DocumentTag DocumentTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@map("DocumentTagLink")

  @@unique([documentId, tagId])
  @@index([tagId])
}

model OutgoingRecord {
  id                BigInt         @id @default(autoincrement())
  documentId        BigInt         @unique
  externalPartyId   Int
  outgoingNumber    String         @unique
  issueDate         DateTime
  signedByUserId    Int
  sendMethod        DeliveryMethod
  isDelivered       Boolean        @default(false)
  deliveryProofPath String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  Document      Document      @relation(fields: [documentId], references: [id], onDelete: Restrict)
  ExternalParty ExternalParty @relation(fields: [externalPartyId], references: [id], onDelete: Restrict)
  User          User          @relation(fields: [signedByUserId], references: [id], onDelete: Restrict)

  @@map("OutgoingRecord")

  @@index([issueDate])
  @@index([externalPartyId])
}

model Role {
  id             Int              @id @default(autoincrement())
  roleName       String           @unique
  description    String?
  UserRole       UserRole[]
  // [NEW]
  RolePermission RolePermission[]

  isSystem Boolean @default(false)

  @@map("Role")

}

model UserRole {
  id         Int      @id @default(autoincrement())
  userId     Int
  roleId     Int
  assignedAt DateTime @default(now())

  Role Role @relation(fields: [roleId], references: [id], onDelete: Restrict)
  User User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("UserRole")


  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model WorkflowInstance {
  id          BigInt         @id @default(autoincrement())
  documentId  BigInt
  currentStep String
  status      WorkflowStatus @default(InProgress)
  startedAt   DateTime       @default(now())
  endedAt     DateTime?

  // لعرض "المعاملات على طاولتي"
  currentAssigneeUserId Int?
  currentAssignee       User? @relation("WorkflowInstanceCurrentAssignee", fields: [currentAssigneeUserId], references: [id], onDelete: SetNull)

  Document           Document             @relation(fields: [documentId], references: [id], onDelete: Cascade)
  WorkflowStepAction WorkflowStepAction[]

  @@map("WorkflowInstance")


  @@index([status])
  @@index([currentAssigneeUserId])
  @@index([documentId])
}

model WorkflowStepAction {
  id               BigInt             @id @default(autoincrement())
  workflowId       BigInt
  stepName         String
  actionType       WorkflowActionType
  actionByUserId   Int
  actionAt         DateTime           @default(now())
  notes            String?
  requiredNextStep String?

  User             User             @relation(fields: [actionByUserId], references: [id], onDelete: Restrict)
  WorkflowInstance WorkflowInstance @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("WorkflowStepAction")


  @@index([workflowId])
  @@index([actionByUserId])
  @@index([actionAt])
}

model IncomingDistributionLog {
  id BigInt @id @default(autoincrement())

  distributionId BigInt
  distribution   IncomingDistribution @relation(fields: [distributionId], references: [id], onDelete: Cascade)

  oldStatus DistributionStatus?
  newStatus DistributionStatus?

  note String?

  updatedByUserId Int
  updatedByUser   User @relation("LogsUpdatedByUser", fields: [updatedByUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@map("IncomingDistributionLog")


  @@index([distributionId])
  @@index([createdAt])
  @@index([updatedByUserId])
}

model NumberSequence {
  id         Int    @id @default(autoincrement())
  scope      String @unique
  lastNumber Int    @default(0)

  @@map("NumberSequence")


  @@index([scope])
}

// =========================
// [NEW] OCR Text for FTS
// =========================
model OCRText {
  id          BigInt   @id @default(autoincrement())
  documentId  BigInt
  textContent String
  language    String?
  createdAt   DateTime @default(now())

  Document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("OCRText")


  @@index([documentId])
}

// =========================
// [NEW] RBAC granular
// =========================
model Permission {
  id             Int              @id @default(autoincrement())
  code           String           @unique
  description    String?
  RolePermission RolePermission[]

  @@map("Permission")

}

model RolePermission {
  id           Int @id @default(autoincrement())
  roleId       Int
  permissionId Int

  Role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  Permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@map("RolePermission")


  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model SecurityLevel {
  id          Int     @id @default(autoincrement())
  levelName   String
  description String?
  rankOrder   Int     @unique

  documents Document[]

  @@map("SecurityLevel")


  @@index([levelName])
}

model PasswordReset {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @db.VarChar(128) // hash للتوكن
  expiresAt DateTime
  usedAt    DateTime?
  createdBy Int? // من أصدر الطلب (أدمن)
  createdAt DateTime  @default(now())

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("PasswordReset")


  @@index([userId])
  @@index([expiresAt])
}

model TimelineEvent {
  id          BigInt   @id @default(autoincrement())
  docId       BigInt
  docType     String // 'INCOMING' | 'OUTGOING'
  actorUserId Int?
  eventType   String // 'FORWARDED'|'ASSIGNED'|'STATUS_CHANGED'|'FILE_UPLOADED'|'FILE_DELETED'|'SLA_REMINDER'|'SLA_ESCALATION' ...
  details     Json?
  createdAt   DateTime @default(now())

  @@map("TimelineEvent")

  @@index([docType, docId, createdAt])
  @@index([createdAt])
}

/// سياسة مستويات التصعيد
model EscalationPolicy {
  id        Int               @id @default(autoincrement())
  name      String            @unique
  isActive  Boolean           @default(true)
  levels    EscalationLevel[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@map("EscalationPolicy")

}

/// مستوى تصعيد واحد ضمن سياسة
model EscalationLevel {
  id       Int              @id @default(autoincrement())
  policyId Int
  policy   EscalationPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  /// رقم المستوى (L1..L4). فريد داخل نفس السياسة
  level            Int
  /// عدد الدقائق بعد الـ dueAt للوصول لهذا المستوى (0 = عند الاختراق)
  thresholdMinutes Int

  /// رفع الأولوية تلقائيًا عند الوصول لهذا المستوى (مرة واحدة)
  priorityBump Int @default(1)

  /// الحالة التي تُفرض عند الوصول لهذا المستوى (غالبًا Escalated)
  statusOnReach DistributionStatus? @default(Escalated)

  /// من L2 فأعلى نُلزم سبب التأخير من الواجهة
  requireDelayReason Boolean @default(false)

  /// من L3 فأعلى يمكن تفعيل إعادة الإسناد التلقائي
  autoReassign Boolean @default(false)

  /// من يتلقى تنبيهات عند هذا المستوى
  notifyAssignee Boolean @default(true)
  notifyManager  Boolean @default(true)
  notifyAdmin    Boolean @default(false)

  /// فترة كبح إعادة إرسال التنبيه لنفس المستوى (بالدقائق)
  throttleMinutes Int @default(60)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("EscalationLevel")
  

  @@unique([policyId, level])
}

model Notification {
  id        Int                  @id @default(autoincrement())
  userId    Int
  title     String
  body      String
  link      String? // رابط يفتح المعاملة/الوارد
  severity  NotificationSeverity @default(info)
  status    NotificationStatus   @default(Unread)
  createdAt DateTime             @default(now())

  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Notification") // <-- مهم! يطابق الجدول الموجود بحرف كبير


  @@index([userId, status, createdAt])
}


model SlaSettings {
  id                 Int      @id @default(1)
  dueSoonHours       Int      @default(24)   // بعد كم ساعة نعتبرها "قريبة من الانتهاء"
  overdueHours       Int      @default(0)    // تأخير مسموح (ساعات) قبل اعتبارها "متأخرة"
  escalateL1Minutes  Int      @default(60)   // تصعيد مستوى 1 بعد كم دقيقة من التأخير
  escalateL2Minutes  Int      @default(120)
  escalateL3Minutes  Int      @default(240)
  escalateL4Minutes  Int      @default(480)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("SlaSettings")
}
