version: "3.9"

name: saraya-archive-dev

services:
  api:
    build:
      context: ./archive-backend
      dockerfile: Dockerfile.dev
    container_name: saraya-api
    environment:
      NODE_ENV: development
      # لو حابب تقفل CORS من Nest خليه فاضي لأننا بنمر عبر Nginx بنفس الأصل
      CORS_ORIGINS: ""
      # مرّر متغيرات قاعدة البيانات هنا أو عبر ملف .env داخل backend
      # DATABASE_URL: postgresql://postgres:postgres@db:5432/saraya?schema=public
    ports:
      - "3000:3000"
    volumes:
      - ./archive-backend:/app
      - /app/node_modules
    networks: [saraya_net]
    # db:
    #   condition: service_healthy

  web:
    build:
      context: ./archive-frontend
      dockerfile: Dockerfile.dev
    container_name: saraya-web
    environment:
      NODE_ENV: development
      # مهم في dev: نخلي الواجهة تكلم الـ API عبر المسار النسبي /api (Nginx سيعمل proxy)
      VITE_API_URL: /api
      # للسماح لـ Vite بالاستماع على كل الواجهات داخل الكونتينر
      HOST: 0.0.0.0
      PORT: 5173
    expose:
      - "5173"
    volumes:
      - ./archive-frontend:/app
      - /app/node_modules
    command: ["pnpm", "dev", "--host", "0.0.0.0", "--port", "5173"]
    networks: [saraya_net]

  nginx:
    image: nginx:1.25-alpine
    container_name: saraya-nginx
    depends_on:
      - web
      - api
    ports:
      - "8080:80"   # افتح المتصفح على http://localhost:8080
    volumes:
      - ./nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [saraya_net]

  # اختياري: PostgreSQL للتطوير
  # db:
  #   image: postgres:15-alpine
  #   container_name: saraya-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     POSTGRES_DB: saraya
  #   ports:
  #     - "5435:5432"
  #   volumes:
  #     - saraya_db:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres -d saraya || exit 1"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 10
  #   networks: [saraya_net]

networks:
  saraya_net:

volumes:
  saraya_db:
